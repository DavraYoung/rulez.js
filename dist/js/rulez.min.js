/*! rulez.js 2015-03-23 */
var Rulez=function(a){"use strict";function b(a){var c,d=a.cloneNode(!1);if(a instanceof Element){var e=window.getComputedStyle(a);if(e)for(c=0;c<e.length;c++){var f=e[c];d.style.setProperty(f,e.getPropertyValue(f),"")}}for(c=0;c<a.childNodes.length;c++)d.appendChild(b(a.childNodes[c]));return d}function c(){C||v.divisions.forEach(function(a){a.pixelGap>C&&(C=a.pixelGap)}),s=B-B%C+C*w,r=-C*w}function d(a,b){v.divisions.forEach(function(c){e(a,b,c)});var c=0;v.texts.forEach(function(d){var e=f(a,b,d);y[c]?y[c]=y[c].concat(e):y.push(e),c++})}function e(a,b,c){for(var d=a;b>d;d+=c.pixelGap){var e=g(d,c);x.appendChild(e),c.renderer&&c.renderer(e)}}function f(a,b,c){for(var d=[],e=a;b>e;e+=c.pixelGap){var f=j(e,c);x.appendChild(f),c.renderer&&c.renderer(f),d.push(f)}return d}function g(a,b){switch(b.type){case"line":return h(a,b);case"rect":return i(a,b);default:return i(a,b)}}function h(a,b){var c,d,e,f,g=document.createElementNS(t,"line"),h=m();return l()?(c="y1",d="y2",e="x1",f="x2"):(c="x1",d="x2",e="y1",f="y2"),g.setAttribute("class",b.className),g.setAttribute(c,p(a)),g.setAttribute(d,p(a)),g.setAttribute(e,p(h?"0":n()-b.lineLength)),g.setAttribute(f,p(h?b.lineLength:n())),g.setAttribute("stroke-width",p(b.strokeWidth)),g}function i(a,b){var c,d,e,f,g=document.createElementNS(t,"rect"),h=m();return l()?(c="y",d="x",e="width",f="height"):(c="x",d="y",e="height",f="width"),g.setAttribute("class",b.className),g.setAttribute(c,p(a)),g.setAttribute(d,p(h?"0":n()-b.lineLength)),g.setAttribute(e,p(b.lineLength)),g.setAttribute(f,p(b.strokeWidth)),g}function j(a,b){var c,d,e,f=document.createElementNS(t,"text"),g=m(),h=g?b.offset:n()-b.offset;return f.setAttribute("class",b.className),l()?(c="y",d="x",e="rotate("+b.rotation+" "+h*D+" "+a*D+")"):(c="x",d="y",e="rotate("+b.rotation+" "+a*D+" "+h*D+")"),f.setAttribute(c,p(a)),f.setAttribute(d,p(h)),f.setAttribute("transform",e),f.textContent=b.showUnits?p(a):a,f}function k(){return document.createElementNS(t,"g")}function l(){return"vertical"===v.layout}function m(){return!("bottom"===v.alignment||"right"===v.alignment)}function n(){return l()?v.width:v.height}function o(a,b,c){if(!b)return a;for(var d in b)if(b.hasOwnProperty(d))switch(d){case"divisionDefaults":case"textDefaults":o(a[d],b[d]);break;default:c&&a[d]||(a[d]=b[d])}return a.divisions&&a.divisions.forEach(function(b){o(b,a.divisionDefaults,b),b.className||(b.className="line"===b.type?"rulez-line":"rulez-rect")}),a.texts&&a.texts.forEach(function(b){o(b,a.textDefaults,b)}),a}function p(a){return a+v.units}function q(){if(""===v.units||"px"===v.units)return 1;var a=document.createElement("div");a.style.position="absolute",a.style.top="-100000px",a.style.left="-100000px",a.style.zIndex=-1e5,a.style.width=a.style.height=p(1),document.body.appendChild(a);var b=window.getComputedStyle(a).width.replace("px","");return document.body.removeChild(a),b}var r,s,t="http://www.w3.org/2000/svg",u={width:null,height:null,element:null,layout:"horizontal",alignment:"top",units:"",divisionDefaults:{strokeWidth:1,type:"rect",className:"rulez-rect",renderer:null},textDefaults:{rotation:0,offset:25,className:"rulez-text",showUnits:!1,renderer:null},divisions:[{pixelGap:5,lineLength:5},{pixelGap:25,lineLength:10},{pixelGap:50,lineLength:15},{pixelGap:100,lineLength:20}],texts:[{pixelGap:100}]},v=o(JSON.parse(JSON.stringify(u)),a),w=2,x=k(),y=[],z=0,A=1;v.width=v.width?v.width:v.element.getBoundingClientRect().width,v.height=v.height?v.height:v.element.getBoundingClientRect().height,v.element.appendChild(x);var B=l()?v.height:v.width,C=0,D=q();this.render=function(){c(),d(r,s)},this.scrollTo=function(a,b){z=a,b&&(z*=D),l()?x.setAttribute("transform","translate(0,"+-z%(C*D)+")"):x.setAttribute("transform","translate("+-z%(C*D)+",0)");for(var c=z/D,d=0;d<v.texts.length;d++)for(var e=v.texts[d],f=y[d],g=C/e.pixelGap,h=c%C,i=c-h,j=0;j<f.length;j++){var k=f[j],m=Math.floor((i+(j-w*g)*e.pixelGap)*A);e.showUnits&&(m=p(m)),k.textContent=m}},this.setScale=function(a){A=a,this.scrollTo(z)},this.resize=function(){var a=B,b=l()?v.element.clientHeight:v.element.clientWidth;if(a!==b)if(a>b);else{B=b;var e=s;c(),d(e,s),this.scrollTo(z)}},this.saveAsImage=function(a){var c=b(v.element);c.setAttribute("width",v.width),c.setAttribute("height",v.height);var d=document.createElement("canvas");d.setAttribute("width",v.width),d.setAttribute("height",v.height);var e=d.getContext("2d"),f=window.URL||window.webkitURL,g=new Image;g.style.position="absolute",g.style.top="-100000px",g.style.left="-100000px",g.style.zIndex=-1e5,g.setAttribute("width",v.width),g.setAttribute("height",v.height);var h=new Blob([c.outerHTML],{type:"image/svg+xml;charset=utf-8"}),i=f.createObjectURL(h);g.onload=function(){setTimeout(function(){e.drawImage(g,0,0),f.revokeObjectURL(i),document.body.removeChild(g),a(d.toDataURL())},1e3)},document.body.appendChild(g),g.src=i},this.getUnitConversionRate=function(){return q()}};